---
title: "Intervention Inclusion Module Vignette"
output: 
  rmarkdown::html_vignette:
      toc: true
      toc_depth: 3
      fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Intervention Inclusion Module Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  

---
```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 4, fig.width = 7)

source("..\\R\\lIntrIncl.R")
```


## Introduction

This vignette aims to describe the intervention inclusion module of the *simple* package.
The purpose of the module is to control the entry and leave of ISA's over time. 

## Function arguments

The module will have global variables as well as specific arguments that can be added and specified in the recruitment function

#### Global variables `lGlobVars` 

Global variables are inputs that are used in different modules and represent a current snapshot of the simulation therefore being subject to changes at every time step. The current time could be an example for a variable of interest for which it makes sense to be globally available.

The following global variables are implemented in the *lIntrIncl* module

**`dCurrTime`**  
Current trial time

**`dActvIntr`**  
Number of ISAs active at beginning of current platform time
   
**`dExitIntr`**  
Number of outgoing ISAs at current platform time
  
**`vIntrInclTimes`**  
Vector of all ISA inclusion times so far
  
**`vIntrExitTimes`**  
Vector of all ISA exit times so far
 




#### Additional arguments `lAddArgs`

Apart from global variables, module specific variables can be added. Examples which are later implemented in the *Examples* section are:

* Different probability parameters *prob* for different points in time.
* A maximum number of total interventions to be included in the trial *dIntrMax*.
* A fixed waiting period *dTimeDiff* after which a new intervention is added

## Functions

### Constructor Function `new_lIntrIncl`
The idea is to be able to include global variables of the simulation as well as any additional variable you would want to impact your recruitment.

The central function of the module is `new_lIntrIncl`. It defines the "rules" of intervention inclusion you want to implement in the simulation.

```{r}
new_lIntrIncl()
```

**`$fnIntrIncl`**
The necessary input is a function `fnIntrIncl` determining when new interventions are added. In the function call you input the global variables to be used in the `lGlobVars` argument and determine the list with further arguments which affect your algorithm in `lAddArgs`. 
Within the curly braces `{}` you execute the function operations.

**`$lAddArgs`**
Here you can supply the list with additional arguments, which are accessed in the function above.


### Helper function `lIntrIncl`

If you do not want to think about an inclusion strategy for interventions, you can use the helper function `lIntrIncl`. 
```{r}
lIntrIncl
```

The only argument you have to enter is the maximum number of total arms you want to allow for the trial. The function then adds an intervention whenever an ISA leaves until the maximum number is reached.
For example: 

```{r}
x <- lIntrIncl(5)

```



### Plot

Plotting objects created by `lIntrIncl` or `new_lIntrIncl` displays the development of patients recruitment as well as the number of active arms over time.

There are a few global variables that this specific plot function requires. `dCurrTime` states the current time point. `intr_itt` and `intr_itt_param` describe the in-trial-time of interventions. Depending on the input for `intr_itt` the function expects different types of input for `intr_itt_param`:

* `intr_itt` = "fixed"
  + `intr_itt_param` $\in \mathbb{N}$ 
  + natural number determining how many time units ISA's stay in the trial
* `intr_itt` = "random"
  + `intr_itt_param` $\in (0,1)$
  + probability of an ISA leaving the trial at every time step


By default ISA's leave after 10 time units which means that `intr_itt` ist "fixed" with `intr_itt_param` 10.

For the actual plot you just call `plot()` with the object you want to plot.

```{r}
x <- lIntrIncl(5)
plot(x)
```

Any changes in global variables can be specified in the plot call. If you are only interested in 20 time steps rather than 52 and want trials to leave with a probability of 0.2 every time step you can call:

```{r}
x <- lIntrIncl(10)
plot(x,
     dCurrTime = 1:20,
     intr_itt = "random",
     intr_itt_param = 0.2)
```


Optionally you can also state the global variables you added in the object created by the `new_lRecrPars` function.



### Summary

The summary call provides information about the input you provided. It gives an overview about global and additional variables as well the function that was implemented.

```{r}
summary(x)
```


## Examples

1. **Replace outgoing ISAs with helper function**

```{r}

x <- lIntrIncl(4)
# in default version, replace every outgoing ISA until a maximum number of ISAs (in this case 4)
plot(x)
# default plot assumes an in-trial time for ISAs of 10 time steps
summary(x)

```

***

2. **Add an intervention every 4 time units**


```{r}

x <- 
  new_lIntrIncl(
    fnIntrIncl  = function(lGlobVars, lAddArgs) {
      # if it has been 4 time units since last inclusion, add one ISA
      if (lGlobVars$lVars$dCurrTime == max(lGlobVars$lVars$vIntrInclTimes) + lAddArgs$dTimeDiff) {
        dAdd <- 1
      } else {
        dAdd <- 0
      }
      return(dAdd)
    },
    lAddArgs      = list(dTimeDiff = 4)
  )
plot(x)
summary(x)

```

***

3. **Random entry of ISAs, add max 2 at a time, maximum 5 parallel**
```{r}

# Add ISAs with random probability
# never more than two at the same time and never allow more than 5 to run in parallel

x <- 
  new_lIntrIncl(
    fnIntrIncl  = function(lGlobVars, lAddArgs) {
      
      if (lGlobVars$lVars$dActvIntr < lAddArgs$dIntrMax) {
        dAdd <- min(rbinom(1, 3, lAddArgs$prob_inclusion), lAddArgs$dIntrMax - lGlobVars$lVars$dActvIntr)
      } else {
        dAdd <- 0
      }
      return(min(2, dAdd))
    },
    lAddArgs      = list(dIntrMax = 5,
                         prob_inclusion = 0.4)
  )
plot(x)
summary(x)


```

***

4. **As before, with inclusion stop for some time points**

```{r}

x <- 
  new_lIntrIncl(
    fnIntrIncl  = function(lGlobVars, lAddArgs) {

      if (lGlobVars$lVars$dActvIntr < lAddArgs$dIntrMax & lGlobVars$lVars$bInclAllowed) {
        dAdd <- min(rbinom(1, 3, lAddArgs$prob_inclusion), lAddArgs$dIntrMax - lGlobVars$lVars$dActvIntr)
      } else {
        dAdd <- 0
      }
      return(min(2, dAdd))
    },
    lAddArgs      = list(dIntrMax = 5,
                         prob_inclusion = 0.4)
  )
plot(
  x,
  bInclAllowed = c(rep(TRUE, 15), rep(FALSE, 15), rep(TRUE, 22))
)
summary(x)

```

***

5. **Different probabilites of inclusion for different time points**

```{r}

# Every 7th time step the probability for inclusion of an arm is increased
x <- new_lIntrIncl(
  fnIntrIncl = function(lGlobVars, lAddArgs) {
    if(lGlobVars$lVars$dCurrTime %% 7 == 0){
      dAdd <- sample(c(1,0), 1, prob = c(lAddArgs$prob_incl_1, 1-lAddArgs$prob_incl_1))
    } else {
      dAdd <- sample(c(1,0), 1, prob = c(lAddArgs$prob_incl_2, 1-lAddArgs$prob_incl_2))
    }
    return(dAdd)
  },
  
  lAddArgs = list(prob_incl_1 = 0.8, prob_incl_2 = 0.1)
)

plot(x)


```

***

6. **Random end of ISAs**
```{r}

# Now the end of ISAs is not after a fixed interval but is randomly drawn
# On average every 5 days an arm enters, and every 10 days an arm leaves

x <- new_lIntrIncl(
  fnIntrIncl = function(lGlobVars, lAddArgs) {
    dAdd <- sample(c(1,0), 1, prob = c(lAddArgs$prob_incl, 1-lAddArgs$prob_incl))
    
    return(dAdd)
  },
  lAddArgs = list(prob_incl = 0.2)
)

plot(x,
     intr_itt = "random",
     intr_itt_param = 0.1)


```


